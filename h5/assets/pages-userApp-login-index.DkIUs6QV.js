import{M as e,d as a,r as l,A as s,O as t,K as o,P as c,Q as u,a as n,w as d,R as i,i as r,o as m,g as f,D as p,p as _,I as v,n as k,q as g,t as x,T as w,v as h,U as y,V as b,s as C,E as V,z as P}from"./index-BvTRnY6x.js";import{r as $}from"./request.BlpNkiyM.js";import{u as U}from"./userinfo.CF3eNbHI.js";const A=P(a({__name:"index",setup(a){const P=U(),A=l(!1),I=l("code"),T=l(!1),j=l(0),z=l(!1),S=l(""),N=l("success"),Z=l("");s(e=>{var a,l;if(e&&e.redirect)Z.value=decodeURIComponent(e.redirect);else{const e=t();if(e.length>1){const s=e[e.length-2],t=s.route||(null==(a=s.$route)?void 0:a.path);if(t&&!t.includes("login")){const e=t.startsWith("/")?t:`/${t}`,a=s.options||(null==(l=s.$page)?void 0:l.options)||{},o=Object.keys(a).map(e=>`${e}=${a[e]}`).join("&");Z.value=o?`${e}?${o}`:e}}}});const q=o({account:"",password:""}),E=o({email:"",code:""}),O=o({email:"",code:"",newPassword:""}),R=e=>{i({title:e})};c(I,e=>{"password"===e||"code"===e?R("登录"):"forgot"===e&&R("忘记密码")}),u(()=>{R("登录")});const D=()=>{"password"===I.value?(I.value="code",q.password="",q.account=E.email):"code"===I.value&&(I.value="password",E.email=q.account,E.code="")},F=()=>{I.value="forgot"},G=()=>{I.value="password"},K=()=>{T.value=!T.value},M=e=>{h({url:"/subPage/mallSys/login/treaty?type="+e})},Q=e=>{if(j.value>0)return;if(!T.value)return void ae("请先阅读并同意用户协议和隐私协议");const a="login"===e?E.email:O.email;var l;a?le(a)?(l={userName:a,type:e},$({url:"/auth/loginVerifEmail",method:"post",data:l,noSignature:!0})).then(e=>{console.log("234234",e),200===e.status?(ae("验证码已发送"),W()):ae(e.msg||"发送验证码失败")}):ae("请输入正确的邮箱格式"):ae("请输入邮箱")},W=()=>{j.value=60;const e=setInterval(()=>{j.value--,j.value<=0&&clearInterval(e)},1e3)},B=async()=>{T.value?q.account?q.password?le(q.account)?(A.value=!0,(async a=>(e&&(a={...a,password:await e(a.password),loginType:"2"}),$({url:"/auth/login",method:"post",data:a,noSignature:!0})))({userName:q.account,password:q.password}).then(e=>{if(200===e.status)J(e);else{if(400===e.status)return S.value="密码错误或用户不存在\n请使用邮箱验证码登录",N.value="error",void(z.value=!0);ae(e.message||"登录失败")}}).catch(e=>{ae(e.message||"登录失败")})):ae("请输入正确的邮箱格式"):ae("请输入密码"):ae("请输入邮箱"):ae("请先阅读并同意用户协议和隐私协议")},H=async()=>{T.value?E.email?le(E.email)?E.code?(A.value=!0,async function(e){return $({url:"/auth/login",method:"post",data:{...e,loginType:"1"},noSignature:!0})}({userName:E.email,verifCode:E.code}).then(e=>{200===e.status?J(e):ae(e.msg||"登录失败")})):ae("请输入验证码"):ae("请输入正确的邮箱格式"):ae("请输入邮箱"):ae("请先阅读并同意用户协议和隐私协议")},J=e=>{ae("登录成功"),y("Token",e.data.token),P.setUserInfo(e.data.userInfo),setTimeout(()=>{Z.value?b({url:Z.value}):C({url:"/pages/userApp/my/index"})},500)},L=async()=>{var e;T.value?O.email?le(O.email)?O.code?O.newPassword?se(O.newPassword)?(A.value=!0,(e={userName:O.email,verifCode:O.code,newPassword:O.newPassword},$({url:"/auth/resetPassword",method:"post",data:e,noSignature:!0})).then(e=>{200===e.status?(ae("密码重置成功"),setTimeout(()=>{I.value="password",q.account=O.email,q.password=""},500)):ae(e.msg||"密码重置失败")})):ae("密码格式不正确，需8~25位，含数字、字母、符号"):ae("请输入新密码"):ae("请输入验证码"):ae("请输入正确的邮箱格式"):ae("请输入邮箱"):ae("请先阅读并同意用户协议和隐私协议")},X=()=>{z.value=!1,I.value="code",E.email=q.account},Y=()=>{z.value=!1,q.account="",q.password=""},ee=()=>{z.value=!1},ae=e=>{V({title:e,icon:"none",duration:2e3})},le=e=>/^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(e),se=e=>/^(?=.*[0-9])(?=.*[a-zA-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,25}$/.test(e);return(e,a)=>{const l=r,s=v,t=k;return m(),n(l,{class:"login-container"},{default:d(()=>[f(l,{class:"login-content"},{default:d(()=>[f(l,{class:"login-title"},{default:d(()=>[_("登录")]),_:1}),"password"===I.value?(m(),n(l,{key:0,class:"login-form"},{default:d(()=>[f(l,{class:"input-item"},{default:d(()=>[f(s,{modelValue:q.account,"onUpdate:modelValue":a[0]||(a[0]=e=>q.account=e),class:"input",placeholder:"请输入邮箱",type:"text"},null,8,["modelValue"])]),_:1}),f(l,{class:"input-item"},{default:d(()=>[f(s,{modelValue:q.password,"onUpdate:modelValue":a[1]||(a[1]=e=>q.password=e),class:"input",placeholder:"请输入密码",password:!0,type:"text"},null,8,["modelValue"])]),_:1}),f(l,{class:"forgot-password",onClick:F},{default:d(()=>[f(t,{class:"forgot-text"},{default:d(()=>[_("忘记密码")]),_:1})]),_:1}),f(l,{class:"agreement-box"},{default:d(()=>[f(l,{class:"checkbox-wrapper",onClick:K},{default:d(()=>[f(l,{class:g(["checkbox",{checked:T.value}])},{default:d(()=>[T.value?(m(),n(t,{key:0,class:"check-icon"},{default:d(()=>[_("✓")]),_:1})):p("",!0)]),_:1},8,["class"]),f(t,{class:"agreement-text"},{default:d(()=>[_("已阅读并同意")]),_:1})]),_:1}),f(t,{class:"link-text",onClick:a[2]||(a[2]=e=>M("userAgreement"))},{default:d(()=>[_("《用户协议》")]),_:1}),f(t,{class:"agreement-text"},{default:d(()=>[_("和")]),_:1}),f(t,{class:"link-text",onClick:a[3]||(a[3]=e=>M("privacyPolicy"))},{default:d(()=>[_("《隐私协议》")]),_:1})]),_:1}),f(l,{class:"btn-login",onClick:B},{default:d(()=>[f(t,{class:"btn-text"},{default:d(()=>[_("登录")]),_:1})]),_:1}),f(l,{class:"switch-login",onClick:D},{default:d(()=>[f(t,{class:"switch-text"},{default:d(()=>[_("使用验证码登录")]),_:1})]),_:1})]),_:1})):p("",!0),"code"===I.value?(m(),n(l,{key:1,class:"login-form"},{default:d(()=>[f(l,{class:"input-item"},{default:d(()=>[f(s,{modelValue:E.email,"onUpdate:modelValue":a[4]||(a[4]=e=>E.email=e),class:"input",placeholder:"请输入邮箱",type:"text"},null,8,["modelValue"])]),_:1}),f(l,{class:"input-item code-input"},{default:d(()=>[f(s,{modelValue:E.code,"onUpdate:modelValue":a[5]||(a[5]=e=>E.code=e),class:"input flex-1",placeholder:"请输入验证码",type:"text",maxlength:"6"},null,8,["modelValue"]),f(l,{class:g(["code-btn",{disabled:j.value>0}]),onClick:a[6]||(a[6]=e=>Q("login"))},{default:d(()=>[f(t,{class:"code-btn-text"},{default:d(()=>[_(x(j.value>0?`${j.value}s`:"获取验证码"),1)]),_:1})]),_:1},8,["class"])]),_:1}),f(l,{class:"agreement-box"},{default:d(()=>[f(l,{class:"checkbox-wrapper",onClick:K},{default:d(()=>[f(l,{class:g(["checkbox",{checked:T.value}])},{default:d(()=>[T.value?(m(),n(t,{key:0,class:"check-icon"},{default:d(()=>[_("✓")]),_:1})):p("",!0)]),_:1},8,["class"]),f(t,{class:"agreement-text"},{default:d(()=>[_("已阅读并同意")]),_:1})]),_:1}),f(t,{class:"link-text",onClick:a[7]||(a[7]=e=>M("userAgreement"))},{default:d(()=>[_("《用户协议》")]),_:1}),f(t,{class:"agreement-text"},{default:d(()=>[_("和")]),_:1}),f(t,{class:"link-text",onClick:a[8]||(a[8]=e=>M("privacyPolicy"))},{default:d(()=>[_("《隐私协议》")]),_:1})]),_:1}),f(l,{class:"btn-login",onClick:H},{default:d(()=>[f(t,{class:"btn-text"},{default:d(()=>[_("登录")]),_:1})]),_:1}),f(l,{class:"switch-login",onClick:D},{default:d(()=>[f(t,{class:"switch-text"},{default:d(()=>[_("使用密码登录")]),_:1})]),_:1})]),_:1})):p("",!0),"forgot"===I.value?(m(),n(l,{key:2,class:"login-form"},{default:d(()=>[f(l,{class:"input-item"},{default:d(()=>[f(s,{modelValue:O.email,"onUpdate:modelValue":a[9]||(a[9]=e=>O.email=e),class:"input",placeholder:"请输入邮箱",type:"text"},null,8,["modelValue"])]),_:1}),f(l,{class:"input-item code-input"},{default:d(()=>[f(s,{modelValue:O.code,"onUpdate:modelValue":a[10]||(a[10]=e=>O.code=e),class:"input flex-1",placeholder:"请输入验证码",type:"text"},null,8,["modelValue"]),f(l,{class:g(["code-btn",{disabled:j.value>0}]),onClick:a[11]||(a[11]=e=>Q("reset"))},{default:d(()=>[f(t,{class:"code-btn-text"},{default:d(()=>[_(x(j.value>0?`${j.value}s`:"获取验证码"),1)]),_:1})]),_:1},8,["class"])]),_:1}),f(l,{class:"input-item"},{default:d(()=>[f(s,{modelValue:O.newPassword,"onUpdate:modelValue":a[12]||(a[12]=e=>O.newPassword=e),class:"input",placeholder:"请输入新密码（8~25位，含数字、字母、符号）",password:!0,type:"text"},null,8,["modelValue"])]),_:1}),f(l,{class:"agreement-box"},{default:d(()=>[f(l,{class:"checkbox-wrapper",onClick:K},{default:d(()=>[f(l,{class:g(["checkbox",{checked:T.value}])},{default:d(()=>[T.value?(m(),n(t,{key:0,class:"check-icon"},{default:d(()=>[_("✓")]),_:1})):p("",!0)]),_:1},8,["class"]),f(t,{class:"agreement-text"},{default:d(()=>[_("已阅读并同意")]),_:1})]),_:1}),f(t,{class:"link-text",onClick:a[13]||(a[13]=e=>M("userAgreement"))},{default:d(()=>[_("《用户协议》")]),_:1}),f(t,{class:"agreement-text"},{default:d(()=>[_("和")]),_:1}),f(t,{class:"link-text",onClick:a[14]||(a[14]=e=>M("privacyPolicy"))},{default:d(()=>[_("《隐私协议》")]),_:1})]),_:1}),f(l,{class:"btn-confirm",onClick:L},{default:d(()=>[f(t,{class:"btn-text"},{default:d(()=>[_("确认")]),_:1})]),_:1}),f(l,{class:"btn-back",onClick:G},{default:d(()=>[f(t,{class:"btn-back-text"},{default:d(()=>[_("返回")]),_:1})]),_:1})]),_:1})):p("",!0)]),_:1}),z.value?(m(),n(l,{key:0,class:"modal-mask",onClick:ee},{default:d(()=>[f(l,{class:"modal-content",onClick:a[15]||(a[15]=w(()=>{},["stop"]))},{default:d(()=>[f(l,{class:"modal-text"},{default:d(()=>[_(x(S.value),1)]),_:1}),"error"===N.value?(m(),n(l,{key:0,class:"modal-actions"},{default:d(()=>[f(l,{class:"modal-btn primary",onClick:X},{default:d(()=>[f(t,{class:"modal-btn-text"},{default:d(()=>[_("邮箱验证码登录")]),_:1})]),_:1}),f(l,{class:"modal-btn",onClick:Y},{default:d(()=>[f(t,{class:"modal-btn-text"},{default:d(()=>[_("换个邮箱试试")]),_:1})]),_:1})]),_:1})):p("",!0)]),_:1})]),_:1})):p("",!0)]),_:1})}}}),[["__scopeId","data-v-843787dc"]]);export{A as default};
