import{d as J,a4 as K,bk as I,b2 as u,aS as W,r as b,h as E,i as Q,m as Y,y as Z,k as w,q as T,A as P,t as ee,w as g,j as O,B as x,p as v,v as B,b6 as te,E as se,bK as ae,bp as ne,N as F,C as D,bL as oe,L as k}from"./index-B-DYpXrm.js";import{u as ce,C as ie,E as le}from"./index-BaHck4XO.js";const re={class:"h-full flex flex-column",style:{padding:"4px"}},fe={class:"flex justify-between radius-box",style:{padding:"10px 12px"}},de={style:{margin:"0"}},ue={class:"flex-1",style:{"margin-top":"4px"}},ge=J({name:"OutView",__name:"out-view",props:{query:{type:Object,default:()=>({})}},setup(S){const h=S,e=K({contractBaseInfo:void 0,templateInfo:{key:"",url:"",isContract:!1},partyList:[],otherList:[],fulfillment:{[u.INCOME]:[],[u.EXPENDITURE]:[]},contractChange:{changeFileList:[],changeAgreementFileList:[],contractChangeRelateProcessList:[],changeReason:"",processInstanceId:"",changeProcessInstanceId:"",processInstanceName:"",signType:""},disabled:!1,mode:I.EDIT,editPermission:{doc:!1,change:!1,baseInfo:!1,party:!1,other:!1,fulfillmentPlan:!1}});ce();const L=W(),V=b("合同详情"),A=()=>{window.opener?window.close():window.location.href="about:blank"},U=async t=>{const s=[],a=[];for(let n of t)n._id=n._id||n.id,n.financeType==u.INCOME?s.push(n):a.push(n);e.fulfillment&&(e.fulfillment[u.INCOME]=s,e.fulfillment[u.EXPENDITURE]=a)},z=t=>{if(t.contractRelateProcessList=t.relateProcessList||[],t.relateProcessList){let s=[];t.relateProcessList.forEach(a=>{s.push(`${a.processName}[${a.processCode}]`)}),t.defaultContractRelateProcessList=s.join("、")}t.notAdd=t.templateContract===1&&!t.contractAllowCustomize},N=b(!1),M=async()=>{var t,s,a;N.value=!0;try{const{contractId:n,onlineOfficeEditAuth:d,contractStructureEditAuth:o}=await ae({contractCode:h.query.contractCode,processInstanceNo:h.query.processInstanceNo}),C=await ne(n);let{controlInfo:l,fileList:y,modifyInfo:c,otherList:_,partyList:$,plainList:X,...i}=C;if(i.businessTypeInfo=i.businessTypeFirstName+"-"+i.businessTypeSecondName,y=y||[],i.fileList=y.map(r=>({id:r.id,fileName:r.fileName,fileType:r.suffix,fileUrl:r.filePath})),l=l?JSON.parse(l):{},l.key=F(),l.isContract){let r=l.url,p=r.substring(r.lastIndexOf(".")+1);l.isContract=p==="pdf"?l.isContract:!1}if(e.templateInfo=l,i.contractAllowCustomize!=null?e.templateInfo.isContract=!i.contractAllowCustomize:e.templateInfo.isContract=!d&&!o,e.partyList=$,e.otherList=_,U(X),[D.CHANGE_IN_APPROVAL].includes(i.status)){if(e.mode=I.CHANGE,i.contractOriginalVO){const r=((a=(s=(t=i.contractOriginalVO)==null?void 0:t.contractSealFileVoList)==null?void 0:s[0])==null?void 0:a.filePath)||"",p=i.contractOriginalVO.contractBodyFilePath||"";e.templateInfo.url=r||p||e.templateInfo.url,e.templateInfo.isContract=!0}if(c&&c.id&&e.contractChange&&[D.CHANGE_IN_APPROVAL].includes(i.status)){e.contractChange.changeReason=c.remark;const r=c.modifyInfoFileList||[],p=[],R=[];if(r.forEach(f=>{const m={id:f.id,fileUrl:f.filePath,fileName:f.fileName,fileType:f.suffix};f.bizType==="CONTRACT_CHANGED_AGREEMENT_FILE"||f.fileName&&(f.fileName.includes("变更协议")||f.fileName.includes("补充协议"))?p.push(m):R.push(m)}),e.contractChange.changeAgreementFileList=p,e.contractChange.changeFileList=R,e.contractChange.signType=c.signType||"NO",e.contractChange.processInstanceId=c.processInstanceId,e.contractChange.changeAmount=c.changeAmount||"",e.contractChange.contractChangeRelateProcessList=c.changeRelateProcessList||[],c.changeRelateProcessList&&c.changeRelateProcessList.length>0){let f=[];c.changeRelateProcessList.forEach(m=>{f.push(`${m.processName}[${m.processCode}]`)}),e.contractChange.defaultcontractChangeRelateProcessList=f.join("、"),e.contractChange.contractChangeRelateProcessList=c.changeRelateProcessList||[]}}}z(i),e.contractBaseInfo=i,e.disabled=!d&&!o,e.editPermission.doc=d,e.editPermission.change=o,e.editPermission.baseInfo=o,e.editPermission.party=o,e.editPermission.other=o,e.editPermission.fulfillmentPlan=o}catch(n){console.error(n)}finally{N.value=!1}},j=()=>{window.opener&&h.query.eventCode&&window.opener.postMessage({eventCode:h.query.eventCode},"*"),A()},G=async t=>{let{contractBaseInfo:s,templateInfo:a,partyList:n,otherList:d,fulfillment:o,changeInfo:C}=await L.value.getSaveData(t);const{fileList:l,businessCodeList:y,cacheCode:c,..._}=s;return{..._,contractFileList:l,controlInfo:JSON.stringify(a),contractOtherList:d,contractPartyList:n,fulfillmentPlainParamList:[...o[u.INCOME],...o[u.EXPENDITURE]],changeProcessInstanceId:e.mode==I.CHANGE?C.processInstanceId:null,contractChange:e.mode==I.CHANGE?{...C}:null}},q=async({event:t,done:s})=>{const a=le.service({fullscreen:!0});try{await L.value.validate();const n=oe,d=await G(a);a.setText("数据提交中...");const o=await n({...d});j(),k.success("提交成功")}catch(n){n.message!=="[object Object]"&&k.warning(n.message)}finally{s(),a.close()}},H=t=>{var a;let s=t.fileUrl.substring(t.fileUrl.lastIndexOf(".")+1);e.templateInfo={key:F(),url:t.fileUrl,isContract:s=="pdf"?!0:!((a=e.editPermission)!=null&&a.doc)||!1}};return M(),(t,s)=>{const a=E("FsButton"),n=E("el-button"),d=E("el-space"),o=Q("loading");return Y((w(),Z("div",re,[T("div",fe,[T("h4",de,ee(V.value),1),P(d,null,{default:g(()=>[P(a,{size:"small",onClick:A},{default:g(()=>s[0]||(s[0]=[v("关 闭")])),_:1,__:[0]}),e.contractBaseInfo&&e.contractBaseInfo.fileType=="add"&&!e.contractBaseInfo.notAdd?(w(),O(B(te),{key:0,accept:".docx,.doc,.pdf",size:100,onSuccess:H},{default:g(()=>[P(n,{type:"primary",size:"small",plain:""},{default:g(()=>s[1]||(s[1]=[v("导入合同")])),_:1,__:[1]})]),_:1})):x("",!0),P(a,{type:"primary",size:"small",onClick:q},{default:g(()=>s[2]||(s[2]=[v("提交审批")])),_:1,__:[2]})]),_:1})]),T("div",ue,[e.contractBaseInfo?(w(),O(B(ie),se({key:0,ref_key:"contractDesignerRef",ref:L},e),null,16)):x("",!0)])])),[[o,N.value]])}}});export{ge as default};
