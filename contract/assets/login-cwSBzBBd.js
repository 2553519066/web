import{d as U,u as q,S as C,cU as I,r,T as k,o as O,i as j,m as b,j as E,k as $,cV as K,cW as R,cX as T,cY as x,cZ as A,c3 as B,c_ as F}from"./index-Cyvvb__l.js";const z=U({__name:"login",setup(P){const w=q(),a=C(),f=I(),h=r(!1),v=r(""),u=r(""),l=r({}),s=r({showState:!0,type:"feishu",gotoUrl:""}),p=r(!1),m=k(()=>"h5,contract".split(",")[1]),g=()=>{u.value="",v.value="",R().then(e=>{v.value=e.image,u.value=e.key})},y=()=>{T().then(e=>{const c=e||[];let o=window.location.hostname;c.length>0?((c||[]).forEach(t=>{t.domainList&&t.domainList.length>0&&t.domainList.forEach(n=>{if(n.includes(o)){const i={appId:t.appId,redirectUrl:n,state:"loading,"+t.appId+","+m.value};l.value=i,s.value.gotoUrl=`https://passport.feishu.cn/suite/passport/oauth/authorize?client_id=${l.value.appId}&redirect_uri=${l.value.redirectUrl}&response_type=code&state=${l.value.state}`}})}),l.value.appId||(s.value.showState=!1)):s.value.showState=!1}).catch(e=>{console.log(e),s.value.showState=!1})},_=(e,c)=>{const o={email:e.email,password:window.btoa(e.password)};u.value&&(o.verCodeKey=u.value,o.verCode=e.verCode),A(o).then(async t=>{const n=new URL(t),i=Object.fromEntries(n.searchParams);B.set(F,i.token),f.setToken(i.token),await f.requestUserInfo(),c();let d=a.query.redirect;d=d?decodeURIComponent(d):"/",w.push(d)}).catch(t=>{t&&t.code=="500001"&&(h.value=!0,g()),c()})},L=e=>{window.location.href=`${s.value.gotoUrl}&tmp_code=${e}`},S=()=>{var o,t,n;let e=window.location.origin;const c={appId:((o=a.query.state)==null?void 0:o.split(",")[1])||"",code:a.query.code,projectCode:((t=a.query.state)==null?void 0:t.split(",")[2])||"",platform:"feishu",redirect:a.query.state&&((n=a.query.state)==null?void 0:n.split(",")[2])==="main"?e+"/main/welcome":""};x(c).then(i=>{window.location.href=i,p.value=!1}).catch(()=>{p.value=!1})};return O(()=>{s.value.type==="feishu"&&s.value.showState&&y(),h.value&&g(),a.query&&a.query.code&&a.query.state&&a.query.state.split(",").includes("loading")&&(p.value=!0,S())}),(e,c)=>{const o=j("loading");return b(($(),E(K,{"has-captcha":h.value,"captcha-img":v.value,LoginState:s.value,onOnSubmit:_,onOnGetCaptcha:g,onOnScanLogin:L},null,8,["has-captcha","captcha-img","LoginState"])),[[o,p.value]])}}});export{z as default};
