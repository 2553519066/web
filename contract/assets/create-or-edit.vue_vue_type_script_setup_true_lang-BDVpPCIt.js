import{d as te,a4 as ae,bk as N,b2 as g,aS as ne,T as se,r as q,h as v,i as oe,m as ce,y as re,k as D,q as x,A as P,t as ie,w as h,j as R,B as F,p as E,v as G,b6 as le,E as fe,L as b,bl as de,N as y,bm as pe,bn as ue,bo as Ie,bp as j,bf as A,C as k,bq as me,br as J,bs as ye,bt as Ce}from"./index-BbO6UiJA.js";import{L as U}from"./StorageCache-CXk3PELT.js";import{u as ge,C as he,E as H}from"./index-BjaAV-EV.js";import{t as Le}from"./todo-Xzh-Ovu9.js";const Te={class:"h-full flex flex-column",style:{padding:"4px"}},Ne={class:"flex justify-between radius-box",style:{padding:"10px 12px"}},_e={style:{margin:"0"}},De={class:"flex-1",style:{"margin-top":"4px"}},Oe=te({name:"ContractCreateOrEdit",__name:"create-or-edit",props:{cacheCode:{type:String,default:"",required:!1},contractId:{type:String,default:"",required:!1},storageId:{type:String,default:"",required:!1}},setup($){const p=$;let L=p.storageId;const e=ae({contractBaseInfo:void 0,templateInfo:{key:"",url:"",isContract:!1},partyList:[],otherList:[],fulfillment:{[g.INCOME]:[],[g.EXPENDITURE]:[]},contractChange:{changeFileList:[],changeAgreementFileList:[],contractChangeRelateProcessList:[],changeReason:"",processInstanceId:"",changeProcessInstanceId:"",processInstanceName:"",signType:""},disabled:!1,mode:p.cacheCode||p.storageId?N.CREATE:N.EDIT}),{closeCurrent:W}=ge(),O=ne(),X=se(()=>e.contractBaseInfo&&e.contractBaseInfo.id?e.contractBaseInfo.name||"编辑合同":p.contractId?"编辑合同":"新增合同"),B=()=>{window.opener?window.close():W()},M=(r,o={})=>{e.otherList=r.map(s=>({...o,fieldDefineId:s.fieldDefineId,fieldDefineInfo:s.fieldDefineInfo,fieldDefineType:s.fieldDefineType,fieldDefineName:s.fieldDefineName,fieldInstanceCode:s.fieldInstanceCode,fieldInstanceData:s.fieldInstanceData,fieldInstanceSeq:s.fieldInstanceSeq}))},z=(r,o={})=>{e.partyList=r.map(s=>{const{id:t,...a}=s;return{...o,...a,contractParty:a.contractParty||a.partyType,_id:t}})},S=async r=>{const o=[],s=[];for(let t of r)t._id=t._id||t.id,t.financeType==g.INCOME?o.push(t):s.push(t);e.fulfillment&&(e.fulfillment[g.INCOME]=o,e.fulfillment[g.EXPENDITURE]=s)},_=r=>{if(r.contractRelateProcessList=r.relateProcessList||[],r.relateProcessList){let o=[];r.relateProcessList.forEach(s=>{o.push(`${s.processName}[${s.processCode}]`)}),r.defaultContractRelateProcessList=o.join("、")}r.notAdd=r.templateContract===1&&!r.contractAllowCustomize},w=q(!1),K=async()=>{var r,o,s;w.value=!0;try{if(p.cacheCode){const t=U.getInstance().getData(p.cacheCode);if(console.log("cacheData",t),!t){b.warning("新增数据不存在或已保存，请新增"),B();return}if(t.templateContract=0,t.type||(t.type="ONE_OFF_CONTRACT"),t.templateId){const{attachmentListBaseInfoList:a,contractTemplate:n,contractTemplatePartyList:c,contractTemplateOtherList:u}=await de(t.templateId);if(t.type=n.contractType,t.templateCode=n.code,t.templateContract=1,t.contractAllowCustomize=n.contractAllowCustomize,_(t),t.fileList=a.map(d=>({_id:d.id||y(),fileName:d.fileName,fileType:d.suffix,fileUrl:d.filePath})),M(u,{fieldInstanceDel:"1"}),z(c||[]),await pe(e.partyList||[]),n.templateInfo){const d=JSON.parse(n.templateInfo);e.templateInfo={...d,isContract:d.isContract||!n.contractAllowCustomize}}}if(t.isContract){let a=t.bodyFilePathSet[0].fileUrl||"",n=a.substring(a.lastIndexOf(".")+1);e.templateInfo.url=a,e.templateInfo.key=y(),e.templateInfo.isContract=n==="pdf"?t.isContract:!1}if(t.relatedContractCode){const{otherList:a,partyList:n,businessTypeSecond:c}=await ue(t.relatedContractCode);M(a.filter(u=>u.fieldDefineType==Ie.TARGET)),await z(n||[]),t.businessTypeSecond=c}if(t.copyContractId){const a=await j(t.copyContractId);let{controlInfo:n,fileList:c,modifyInfo:u,otherList:d,partyList:C,plainList:i,...l}=a;l.businessTypeInfo=l.businessTypeFirstName+"-"+l.businessTypeSecondName,c=c||[],u=u||{},l.fileList=c.map(f=>({_id:f.id||y(),fileName:f.fileName,fileType:f.suffix,fileUrl:f.filePath})),delete l.id,_(l),l.code="",e.templateInfo=n?JSON.parse(n):{},e.templateInfo.key=y(),e.contractBaseInfo=l,e.partyList=C.map(f=>(f._id=f.id,delete f.id,f)),e.otherList=d.map(f=>(delete f.id,f));const m=A(A().subtract(1,"day").format("YYYY-MM-DD 00:00:00"));i=i.filter(f=>(f.fulfillStatus="WAIT_PROMISE",f._id=f.id,delete f.id,delete f.code,m.isBefore(A(A(f.fulfillDate).format("YYYY-MM-DD 00:00:00"))))),S(i);return}e.templateInfo.key=y(),e.contractBaseInfo=t||{}}if(p.contractId){const t=await j(p.contractId);let{controlInfo:a,fileList:n,modifyInfo:c,otherList:u,partyList:d,plainList:C,...i}=t;if(i.businessTypeInfo=i.businessTypeFirstName+"-"+i.businessTypeSecondName,n=n||[],i.fileList=n.map(l=>({id:l.id,fileName:l.fileName,fileType:l.suffix,fileUrl:l.filePath})),a=a?JSON.parse(a):{},a.key=y(),a.isContract){let l=a.url,m=l.substring(l.lastIndexOf(".")+1);a.isContract=m==="pdf"?a.isContract:!1}if(e.templateInfo=a,i.contractAllowCustomize!=null&&(e.templateInfo.isContract=!i.contractAllowCustomize),e.partyList=d,e.otherList=u,S(C),[k.IN_FULFILLMENT,k.CHANGED_WAITE_APPROVAL].includes(i.status)){if(e.mode=N.CHANGE,i.contractOriginalVO){const l=((s=(o=(r=i.contractOriginalVO)==null?void 0:r.contractSealFileVoList)==null?void 0:o[0])==null?void 0:s.filePath)||"",m=i.contractOriginalVO.contractBodyFilePath||"";e.templateInfo.url=l||m||e.templateInfo.url,e.templateInfo.isContract=!0}if(c&&c.id&&e.contractChange&&[k.CHANGED_WAITE_APPROVAL].includes(i.status)){e.contractChange.changeReason=c.remark;const l=c.modifyInfoFileList||[],m=[],f=[];if(l.forEach(I=>{const T={id:I.id,fileUrl:I.filePath,fileName:I.fileName,fileType:I.suffix};I.bizType==="CONTRACT_CHANGED_AGREEMENT_FILE"||I.fileName&&(I.fileName.includes("变更协议")||I.fileName.includes("补充协议"))?m.push(T):f.push(T)}),e.contractChange.changeAgreementFileList=m,e.contractChange.changeFileList=f,e.contractChange.signType=c.signType||"NO",e.contractChange.processInstanceId=c.processInstanceId,e.contractChange.changeAmount=c.changeAmount||"",e.contractChange.contractChangeRelateProcessList=c.changeRelateProcessList||[],c.changeRelateProcessList&&c.changeRelateProcessList.length>0){let I=[];c.changeRelateProcessList.forEach(T=>{I.push(`${T.processName}[${T.processCode}]`)}),e.contractChange.defaultcontractChangeRelateProcessList=I.join("、"),e.contractChange.contractChangeRelateProcessList=c.changeRelateProcessList||[]}}}_(i),e.contractBaseInfo=i}if(L){const t=await Le(L);let{contractFileList:a,controlInfo:n,contractOtherList:c,contractPartyList:u,fulfillmentPlainParamList:d,...C}=JSON.parse(t.todoInfo);if(n=JSON.parse(n),n.key=y(),n.isContract){let i=n.url,l=i.substring(i.lastIndexOf(".")+1);n.isContract=l==="pdf"?n.isContract:!1}e.templateInfo=n,e.partyList=u,e.otherList=c,S(d),_(C),e.contractBaseInfo=C}}catch(t){console.error(t)}finally{w.value=!1}},V=async r=>{let{contractBaseInfo:o,templateInfo:s,partyList:t,otherList:a,fulfillment:n,changeInfo:c}=await O.value.getSaveData(r);const{fileList:u,businessCodeList:d,cacheCode:C,...i}=o;return{...i,contractFileList:u,controlInfo:JSON.stringify(s),contractOtherList:a,contractPartyList:t,fulfillmentPlainParamList:[...n[g.INCOME],...n[g.EXPENDITURE]],changeProcessInstanceId:e.mode==N.CHANGE?c.processInstanceId:null,contractChange:e.mode==N.CHANGE?{...c}:null}},Q=async({event:r,done:o})=>{const s=H.service({fullscreen:!0});try{const t=await V(s);s.setText("数据保存中...");const a=await me({id:L,contractCode:t.code,contractName:t.name,todoInfo:JSON.stringify(t)});p.cacheCode&&U.getInstance().removeData(p.cacheCode),L=a,J("ContractTodo"),b.success("保存成功")}catch(t){console.log(t)}finally{o(),s.close()}},Z=async({event:r,done:o})=>{var t;const s=H.service({fullscreen:!0});try{await O.value.validate();const a=(t=e.contractBaseInfo)!=null&&t.id?ye:Ce,n=await V(s);s.setText("数据提交中...");const c=await a({todoInfoId:L,...n});p.cacheCode&&U.getInstance().removeData(p.cacheCode),J("ContractList"),b.success("提交成功"),B()}catch(a){a.message!=="[object Object]"&&b.warning(a.message)}finally{o(),s.close()}},ee=r=>{let o=r.fileUrl.substring(r.fileUrl.lastIndexOf(".")+1);e.templateInfo={key:y(),url:r.fileUrl,isContract:o==="pdf"}},Y=q(!1);return K(),(r,o)=>{const s=v("FsButton"),t=v("el-button"),a=v("el-space"),n=oe("loading");return ce((D(),re("div",Te,[x("div",Ne,[x("h4",_e,ie(X.value),1),P(a,null,{default:h(()=>{var c;return[P(s,{size:"small",onClick:B},{default:h(()=>o[0]||(o[0]=[E("关 闭")])),_:1,__:[0]}),e.contractBaseInfo&&e.contractBaseInfo.fileType=="add"&&!e.contractBaseInfo.notAdd?(D(),R(G(le),{key:0,accept:".docx,.doc,.pdf",size:100,onSuccess:ee},{default:h(()=>[P(t,{type:"primary",size:"small",plain:""},{default:h(()=>o[1]||(o[1]=[E("导入合同")])),_:1,__:[1]})]),_:1})):F("",!0),(c=e.contractBaseInfo)!=null&&c.id?F("",!0):(D(),R(s,{key:1,type:"primary",size:"small",disabled:Y.value,onClick:Q},{default:h(()=>o[2]||(o[2]=[E("暂 存")])),_:1,__:[2]},8,["disabled"])),P(s,{type:"primary",size:"small",disabled:Y.value,onClick:Z},{default:h(()=>o[3]||(o[3]=[E("确认生成")])),_:1,__:[3]},8,["disabled"])]}),_:1})]),x("div",De,[e.contractBaseInfo?(D(),R(G(he),fe({key:0,ref_key:"contractDesignerRef",ref:O},e),null,16)):F("",!0)])])),[[n,w.value]])}}});export{Oe as _};
